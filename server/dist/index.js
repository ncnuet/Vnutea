(()=>{"use strict";var e={3114:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3518),o=i(n(5343)),{CLOUDINARY_CLOUD_NAME:a,CLOUDINARY_API_KEY:s,CLOUDINARY_API_SECRET:u}=o.default;r.v2.config({cloud_name:a,api_key:s,api_secret:u}),t.default=r.v2},4742:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.withAge=t.cookieSecureOption=void 0,t.cookieSecureOption={httpOnly:!0,secure:!0},t.withAge=function(e){return Object.assign(Object.assign({},t.cookieSecureOption),{maxAge:e})}},2009:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.connect=void 0;const o=r(n(1185)),a=r(n(5343)),{MG_HOST:s,MG_NAME:u,MG_USERNAME:c,MG_PASSWORD:d,MONGODB_URI:l}=a.default;o.default.set("strictQuery",!0);const f=l||`mongodb+srv://${c}:${d}@${s}/${u}?retryWrites=true&w=majority`;t.connect=()=>i(void 0,void 0,void 0,(function*(){return o.default.connect(f)}))},5343:function(e,t,n){var i=this&&this.__rest||function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.env=void 0;const o=n(5142),a=r(n(1017)),s=process.env,{NODE_ENV:u}=s,c=i(s,["NODE_ENV"])||{},d=(0,o.config)("dev"===u?{path:a.default.resolve(process.cwd(),".env.dev")}:void 0).parsed;t.env="production",t.default=Object.assign(Object.assign(Object.assign({},d),{ENV:"production"}),c)},1633:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JWTResetOpt=t.JWTRefreshOpt=t.JWTTokenOpt=void 0;const r=i(n(5343));t.JWTTokenOpt={expiresIn:"dev"===r.default.ENV?"10s":"3600s"},t.JWTRefreshOpt={expiresIn:"dev"===r.default.ENV?"3600s":"86400s"},t.JWTResetOpt={expiresIn:"dev"===r.default.ENV?"180s":"300s"}},9818:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startup=t.setupRedisIndex=t.redis=void 0;const o=n(7773),a=r(n(5343)),s=n(9372);function u(){return i(this,void 0,void 0,(function*(){yield(0,s.setTokenIndex)()}))}t.redis=(0,o.createClient)({password:a.default.RD_PASSWORD,socket:{host:a.default.RD_HOST,port:Number(a.default.RD_PORT)}}),t.setupRedisIndex=u,t.startup=function(){return i(this,void 0,void 0,(function*(){yield t.redis.connect(),yield u()}))}},6464:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417),a=n(4742),s=n(7797),u=r(n(9412)),c=r(n(4747)),d=r(n(5215)),l=r(n(4947)),f=n(2790),h=r(n(9660)),p=r(n(7315)),v=r(n(5805)),m=r(n(8047)),y=r(n(7649)),_=r(n(203)),g=r(n(7148));class w{static precheck(e){return i(this,void 0,void 0,(function*(){if(e.department&&0===(yield g.default.get([e.department])).length)throw new o.InputError("Invalid department id","department")}))}static login(e,t){return i(this,void 0,void 0,(function*(){const n=e.body;console.log(n),yield(0,u.default)(t,(()=>i(this,void 0,void 0,(function*(){c.default.validateLogin(n);const e=yield d.default.findUserByPassword(n.username,n.password);if(e){const i=(yield l.default.getVersion(e.uid))||"0",r=(0,s.generateToken)(Object.assign(Object.assign({},e),{version:i,remember:n.remember}),!0);yield l.default.insertRefreshToken(r.refreshToken,e.uid,e.role),function(e,t,n,i){i&&e.cookie("refresh_token",i,(0,a.withAge)(864e5)),e.status(200).cookie("token",n,(0,a.withAge)(t?36e5:void 0)).json({message:"success",data:{accessToken:n,refreshToken:i}}).send()}(t,n.remember,r.accessToken,r.refreshToken)}else t.status(401).json({message:"Invalid username or password",name:"password"})}))))}))}static logout(e,t){return i(this,void 0,void 0,(function*(){const e=t.locals.user;yield(0,u.default)(t,(()=>i(this,void 0,void 0,(function*(){l.default.deleteRefreshToken(e.uid),l.default.updateVersion(e.uid),t.cookie("token",null,(0,a.withAge)(0)),t.cookie("refresh_token",null,(0,a.withAge)(0)),t.sendStatus(200)}))))}))}static create(e,t){return i(this,void 0,void 0,(function*(){const n=e.body,r=t.locals.user;(0,u.default)(t,(()=>i(this,void 0,void 0,(function*(){_.default.validateCreate(n),yield w.precheck(n);const e=yield v.default.create(r.uid,{name:n.name,username:n.username,role:n.role});var i=null;n.role===f.EUserRole.STUDENT?(m.default.validateCreate(Object.assign(Object.assign({},n),{user:e})),i=yield p.default.create({creator:r.uid,department:n.department,name:n.name,user:e})):n.role===f.EUserRole.TEACHER&&(y.default.validateCreate(Object.assign(Object.assign({},n),{user:e})),i=yield h.default.create({creator:r.uid,department:n.department,name:n.name,user:e})),t.json({message:"Created successfully",data:{id:e,password:"123456789",role:n.role,profile_id:i}})}))))}))}static delete(e,t){return i(this,void 0,void 0,(function*(){const n=e.params.id;(0,u.default)(t,(()=>i(this,void 0,void 0,(function*(){_.default.validateDelete({id:n});const e=yield v.default.delete(n),i=(yield h.default.delete(n))&&(yield p.default.delete(n));t.status(200).json({message:e&&i?"Delete successfully":"Unable to delete",data:{id:n}})}))))}))}}t.default=w},6319:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(7035)),a=r(n(6362)),s=r(n(9412)),u=r(n(4216));t.default=new class{createMessage(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=(e.params.roomID,e.body);(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){if(u.default.validateCreateMessage(r),!(yield a.default.getRoom(r.roomID,n.uid)))throw new Error("Invalid roomID",{cause:"roomID"});yield o.default.createMessage(r.roomID,n.uid,r.message,r.type),t.json({message:"success"})}))))}))}}},8964:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417),a=r(n(9412)),s=r(n(3114)),u=r(n(9416)),c=r(n(5805)),d=n(2790),l=r(n(7148));class f{static precheck(e){return i(this,void 0,void 0,(function*(){if(e.dean){const t=yield c.default.getUsers([e.dean]);if(0===t.length)throw new o.InputError("Invalid dean id","dean");if(t[0].role!==d.EUserRole.TEACHER)throw new o.InputError("Invalid role of dean","dean")}}))}static create(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.body,o=e.files;(0,a.default)(t,(()=>i(this,void 0,void 0,(function*(){r.contact="string"==typeof r.contact?JSON.parse(r.contact):r.contact,r.details="string"==typeof r.details?JSON.parse(r.details):r.details,u.default.validateCreate(Object.assign(Object.assign({},r),{image:o?"true":void 0})),yield f.precheck(r);const e=o.image,i=yield s.default.uploader.upload(e.tempFilePath,{public_id:e.name,resource_type:"auto",folder:"uploaded",use_filename:!0,unique_filename:!1});if(i.secure_url){const e=yield l.default.create({image:i.secure_url,dean:r.dean,contact:r.contact,name:r.name,description:r.description,details:r.details,creator:n.uid});t.status(200).send({message:"Success",data:{id:e}})}else t.status(500).send({message:"Unable to upload image"})}))))}))}static delete(e,t){return i(this,void 0,void 0,(function*(){const n=e.params.id;(0,a.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateDelete({id:n});const e=yield l.default.delete(n);t.status(200).send({message:e?"Deleted successfully":"Unable to delete",data:{id:n}})}))))}))}}t.default=f},1329:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417),a=r(n(9412)),s=r(n(3114)),u=r(n(5805)),c=n(2790),d=r(n(7148)),l=r(n(8937)),f=r(n(608));class h{static precheck(e){return i(this,void 0,void 0,(function*(){if(e.dean){const t=yield u.default.getUsers([e.dean]);if(0===t.length)throw new o.InputError("Invalid dean id","dean");if(t[0].role!==c.EUserRole.TEACHER)throw new o.InputError("Invalid role of dean","dean")}if(e.department&&0===(yield d.default.get([e.department])).length)throw new o.InputError("Invalid department id","department")}))}static create(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.body,o=e.files;(0,a.default)(t,(()=>i(this,void 0,void 0,(function*(){r.contact="string"==typeof r.contact?JSON.parse(r.contact):r.contact,r.details="string"==typeof r.details?JSON.parse(r.details):r.details,l.default.validateCreate(Object.assign(Object.assign({},r),{image:o?"true":void 0})),yield h.precheck(r);const e=o.image,i=yield s.default.uploader.upload(e.tempFilePath,{public_id:e.name,resource_type:"auto",folder:"uploaded",use_filename:!0,unique_filename:!1});if(i.secure_url){const e=yield f.default.create({image:i.secure_url,dean:r.dean,contact:r.contact,name:r.name,description:r.description,details:r.details,creator:n.uid,department:r.department});t.status(200).send({message:"Success",data:{id:e}})}else t.status(500).send({message:"Unable to upload image"})}))))}))}static delete(e,t){return i(this,void 0,void 0,(function*(){const n=e.params.id;(0,a.default)(t,(()=>i(this,void 0,void 0,(function*(){l.default.validateDelete({id:n});const e=yield f.default.delete(n);t.status(200).send({message:e?"Deleted successfully":"Unable to delete",data:{id:n}})}))))}))}}t.default=h},4107:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(7148)),a=r(n(608)),s=n(9125),u=r(n(9660)),c=r(n(5805)),d=n(5417),l=r(n(9412)),f=r(n(1529));class h{static checkValidFavouriteRef(e){return i(this,void 0,void 0,(function*(){switch(e.type){case s.EFavouriteType.TEACHER:if(0===(yield u.default.get([e.ref])).length)throw new d.InputError("Invalid ref id","ref");break;case s.EFavouriteType.DEPARTMENT:if(0===(yield o.default.get([e.ref])).length)throw new d.InputError("Invalid ref id","ref");break;case s.EFavouriteType.LAB:if(0===(yield a.default.get([e.ref])).length)throw new d.InputError("Invalid ref id","ref")}}))}static getProfile(e,t){return i(this,void 0,void 0,(function*(){const e=t.locals.user;(0,l.default)(t,(()=>i(this,void 0,void 0,(function*(){t.status(200).json({message:"successfully",data:{role:e.role,username:e.username,name:e.name}})}))))}))}static addFavorite(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.body;(0,l.default)(t,(()=>i(this,void 0,void 0,(function*(){console.log(r),f.default.validateAddFavourite(r),yield h.checkValidFavouriteRef(r);const e=c.default.addFavorite(n.uid,r);t.json({message:e?"Added successfully":"Unable to add"})}))))}))}static getFavorite(e,t){return i(this,void 0,void 0,(function*(){const e=t.locals.user;(0,l.default)(t,(()=>i(this,void 0,void 0,(function*(){const n=yield c.default.getFavourites(e.uid);t.status(200).json({message:"success",data:{favorites:n}})}))))}))}}t.default=h},4340:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(8101)),a=n(5417),s=r(n(9412)),u=r(n(4539)),c=r(n(3114)),d=n(6638),l=r(n(5805)),f=n(2790),h=r(n(7148)),p=r(n(608));class v{static precheck(e){return i(this,void 0,void 0,(function*(){switch(e.type){case d.EOutstandingType.TEACHER:const t=yield l.default.getUsers([e.ref]);if(0===t.length)throw new a.InputError("Invalid ref id","ref");if(t[0].role!==f.EUserRole.TEACHER)throw new a.InputError("Invalid role ref","ref");break;case d.EOutstandingType.DEPARTMENT:if(0===(yield h.default.get([e.ref])).length)throw new a.InputError("Invalid ref id","ref");break;case d.EOutstandingType.LAB:if(0===(yield p.default.get([e.ref])).length)throw new a.InputError("Invalid ref id","ref")}}))}static create(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.body,a=e.files;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateCreate(Object.assign(Object.assign({},r),{image:a?"true":void 0})),yield v.precheck(r);const e=a.image,i=yield c.default.uploader.upload(e.tempFilePath,{public_id:e.name,resource_type:"auto",folder:"uploaded",use_filename:!0,unique_filename:!1});if(i.secure_url){const e=yield o.default.create({image:i.secure_url,ref:r.ref,type:r.type,creator:n.uid});t.status(200).send({message:"Success",data:{id:e}})}else t.status(500).send({message:"Unable to upload image"})}))))}))}static delete(e,t){return i(this,void 0,void 0,(function*(){const n=e.params.id;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateDelete({id:n});const e=yield o.default.delete(n);t.status(200).send({message:e?"Deleted successfully":"Unable to delete",data:{id:n}})}))))}))}}t.default=v},8665:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(6362)),a=r(n(5805)),s=r(n(9412)),u=r(n(4216));t.default=new class{createRoom(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.body;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){if(u.default.validateCreateRoom(r),!(yield a.default.validateUID(r.participants)))return void t.status(400).json({message:"Invalid participant IDs"});const e=yield o.default.findByParticipants(r.participants);if(e)t.status(200).json({message:"The room has been created previously",data:{is_new:!1,room_id:e._id}});else{const e=yield o.default.createRoom(n.uid,r.participants,r.name);t.status(200).json({message:"The room has been created successfully",data:{is_new:!0,room_id:e._id}})}}))))}))}deleteRoom(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.params.roomID;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateDeleteRoom({roomID:r}),(yield o.default.deleteRoom(r,n.uid))?t.status(200).json({message:"The room has been deleted successfully",data:{roomID:r}}):t.status(400).json({message:"You have not permission to delete this room",data:{roomID:r}})}))))}))}getRoomByID(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,r=e.params.roomID;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateGetRoom({roomID:r});const e=yield o.default.getRoom(r,n.uid);t.json({message:"success",data:{room:e}})}))))}))}updateRoomName(e,t){return i(this,void 0,void 0,(function*(){const n=t.locals.user,{name:r}=e.body,a=e.params.roomID;(0,s.default)(t,(()=>i(this,void 0,void 0,(function*(){u.default.validateUpdateRoom({roomID:a});const e=yield o.default.updateRoom(a,n.uid,r);t.json({message:"success",data:e})}))))}))}}},7782:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(7148)),a=r(n(608)),s=r(n(9660)),u=r(n(9412));t.default=class{static search(e,t){return i(this,void 0,void 0,(function*(){const n=e.query;(0,u.default)(t,(()=>i(this,void 0,void 0,(function*(){const[e,i,r]=yield Promise.all([s.default.search(n.query),a.default.search(n.query),o.default.search(n.query)]);t.status(200).json({message:"success",data:{query:n.query,users:e,labs:i,departments:r}})}))))}))}}},3607:function(e,t,n){e=n.nmd(e);var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=s(n(6860)),c=s(n(7806)),d=s(n(9470)),l=s(n(6674)),f=s(n(9710)),h=o(n(3582)),p=n(3952),v=n(8849),m=s(n(8479)),y=s(n(5343)),_=o(n(2009)),g=o(n(9818)),w=(0,u.default)(),O=y.default.PORT,b=(0,v.createServer)(w);w.use((0,d.default)("tiny")),w.use((0,c.default)()),w.use(u.default.json()),w.use(u.default.urlencoded({extended:!0})),w.use((0,f.default)()),w.use((0,l.default)({useTempFiles:!0,limits:{fileSize:52428800}})),w.use(h.default({origin:y.default.CORS_ORIGIN,credentials:!0,methods:["GET","PUT","POST","DELETE"],optionsSuccessStatus:200})),(0,m.default)(w),new p.Server(b).on("connection",(e=>{console.log("a user connected"),e.emit("test","Hello Testing event!")})),n.c[n.s]===e&&b.listen(O,(()=>a(void 0,void 0,void 0,(function*(){yield g.startup(),console.log("📕 [redis]: Connected to redis"),yield _.connect(),console.log("📒 [mongo]: Connected to mysql"),console.log(`✅ [server]: Server is running at http://localhost:${O}`)})))),t.default=w},322:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkJWT=void 0;const u=o(n(9344)),c=s(n(5343)),d=n(5326),l=s(n(4947));t.checkJWT=function(e,t,n){return a(this,void 0,void 0,(function*(){const i=this&&"query"===this.tokenOn?e.query.token:e.cookies.token;if(!i)return t.sendStatus(401);try{const e=u.verify(i,c.default.JWT_KEY),r=yield l.default.getVersion(e.uid);if(r&&r!==e.version)return t.sendStatus(401);t.locals.user=e,n()}catch(i){if(!(i instanceof u.TokenExpiredError))return console.log(i),t.sendStatus(401);(0,d.checkRWT)(e,t,n)}}))}},5326:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkRWT=void 0;const u=o(n(9344)),c=s(n(5343)),d=n(7797),l=s(n(4947)),f=n(4742),h=s(n(9412));t.checkRWT=function(e,t,n){return a(this,void 0,void 0,(function*(){const i=e.cookies.refresh_token;(0,h.default)(t,(()=>a(this,void 0,void 0,(function*(){if(!i||!(yield l.default.getRefreshToken(i)))return t.sendStatus(401);try{const e=u.verify(i,c.default.JWT_REFRESH_KEY);e.role=yield l.default.getRole(e.uid),e.version=yield l.default.getVersion(e.uid);const r=(0,d.generateToken)(e,!0);yield l.default.insertRefreshToken(r.refreshToken,e.uid,e.role),t.cookie("refresh_token",r.refreshToken,(0,f.withAge)(864e5)).cookie("token",r.accessToken,(0,f.withAge)(e.remember?36e5:void 0)).locals.user=e,n()}catch(e){console.log(e),t.sendStatus(401)}}))))}))}},944:function(e,t){var n=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.checkRole=void 0,t.checkRole=function(e,t,i){return n(this,void 0,void 0,(function*(){const{role:e}=t.locals.user;if(!e||!this.role.includes(e))return t.sendStatus(401);i()}))}},5215:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(6820),u=o(n(8432));t.default=new class{findUserByPassword(e,t){return a(this,void 0,void 0,(function*(){const n=yield s.UserBaseModel.findOne({username:e},{_id:1,role:1,username:1,password:1,name:1}).exec();if(!n)return;const{_id:i,username:r,password:o,role:a,name:c}=n;return t?(yield u.compare(t,o))&&{uid:i.toString(),username:r,role:a,name:c}:void 0}))}findUserByInfo(e){return a(this,void 0,void 0,(function*(){const t=yield s.UserBaseModel.findOne({$or:[{username:e.username},{email:e.email},{_id:e.uid}]},{email:!0,username:!0,phone:!0,_id:!0}).exec();if(!t)return;const{username:n,_id:i,email:r}=t;return{username:n,uid:i.toString(),email:r}}))}}},6479:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DepartmentBaseModel=void 0;const i=n(1185),r=n(4448);t.DepartmentBaseModel=(0,i.model)("Department",r.DepartmentSchema)},1217:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LabBaseModel=void 0;const i=n(1185),r=n(7581);t.LabBaseModel=(0,i.model)("Lab",r.LabSchema)},3069:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageBaseModel=void 0;const i=n(1185),r=n(2045);t.MessageBaseModel=(0,i.model)("Message",r.MessageSchema)},2649:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OutstandingBaseModel=void 0;const i=n(1185),r=n(6638);t.OutstandingBaseModel=(0,i.model)("Outstanding",r.OutstandingSchema)},7964:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RoomBaseModel=void 0;const i=n(1185),r=n(9978);t.RoomBaseModel=(0,i.model)("ChatRoom",r.RoomSchema)},1778:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StudentBaseModel=void 0;const r=n(1185),o=i(n(4315));t.StudentBaseModel=(0,r.model)("Student",o.default)},18:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TeacherBaseModel=void 0;const i=n(1185),r=n(1868);t.TeacherBaseModel=(0,i.model)("Teacher",r.TeacherSchema)},6820:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UserBaseModel=void 0;const r=n(1185),o=i(n(5102));t.UserBaseModel=(0,r.model)("User",o.default)},7035:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2045),o=n(3069);t.default=new class{createMessage(e,t,n,a=r.MESSAGE_TYPES.TEXT){return i(this,void 0,void 0,(function*(){yield o.MessageBaseModel.create({roomID:e,message:n,createdBy:t,type:a,seenBy:{uid:t}})}))}}},7148:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6479);t.default=class{static create(e){return i(this,void 0,void 0,(function*(){const{name:t,dean:n,description:i,contact:o,details:a,image:s,creator:u}=e;return(yield r.DepartmentBaseModel.create({name:t,dean:n,description:i,contact:o,details:a,image:s,creator:u}))._id}))}static delete(e){return i(this,void 0,void 0,(function*(){return(yield r.DepartmentBaseModel.deleteOne({_id:e}).exec()).acknowledged}))}static search(e){return i(this,void 0,void 0,(function*(){return(yield r.DepartmentBaseModel.search({match:{name:{query:e,fuzziness:"auto",fuzzy_transpositions:!0}}},{hydrate:!0,hydrateOptions:{select:"name _id"}})).body.hits.hydrated}))}static get(e){return i(this,void 0,void 0,(function*(){return yield r.DepartmentBaseModel.find({_id:{$in:e}}).exec()}))}}},608:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1217);t.default=class{static create(e){return i(this,void 0,void 0,(function*(){const{name:t,dean:n,description:i,contact:o,details:a,image:s,creator:u,department:c}=e;return(yield r.LabBaseModel.create({name:t,dean:n,description:i,contact:o,details:a,image:s,creator:u,department:c}))._id}))}static delete(e){return i(this,void 0,void 0,(function*(){return(yield r.LabBaseModel.deleteOne({_id:e}).exec()).acknowledged}))}static search(e){return i(this,void 0,void 0,(function*(){return(yield r.LabBaseModel.search({match:{name:{query:e,fuzziness:"auto",fuzzy_transpositions:!0}}},{hydrate:!0,hydrateOptions:{select:"name _id"}})).body.hits.hydrated}))}static get(e){return i(this,void 0,void 0,(function*(){return yield r.LabBaseModel.find({_id:{$in:e}}).exec()}))}}},8101:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2649);t.default=class{static create(e){return i(this,void 0,void 0,(function*(){const{creator:t,image:n,ref:i,type:o}=e;return(yield r.OutstandingBaseModel.create({creator:t,image:n,ref:i,type:o}))._id}))}static delete(e){return i(this,void 0,void 0,(function*(){return(yield r.OutstandingBaseModel.deleteOne({_id:e}).exec()).acknowledged}))}static get(){return i(this,void 0,void 0,(function*(){return yield r.OutstandingBaseModel.find().exec()}))}}},6362:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(7964);var a=r(n(1185)).default.Types.ObjectId;t.default=new class{findByParticipants(e){return i(this,void 0,void 0,(function*(){return(yield o.RoomBaseModel.findOne({participants:{$size:e.length,$all:[...e]}}).exec())||void 0}))}createRoom(e,t,n){return i(this,void 0,void 0,(function*(){return t.push(e),yield o.RoomBaseModel.create({name:n,initiator:e,participants:t,room_type:t.length>2?"group":"P2P"})}))}deleteRoom(e,t){return i(this,void 0,void 0,(function*(){return(yield o.RoomBaseModel.deleteOne({_id:e,initiator:t}).exec()).deletedCount>0&&e}))}getRoom(e,t){return i(this,void 0,void 0,(function*(){return yield o.RoomBaseModel.findOne({_id:e,participants:{$elemMatch:{$eq:new a(t)}}}).exec()}))}getRoomHasUser(e){return i(this,void 0,void 0,(function*(){return yield o.RoomBaseModel.find({participants:{$elemMatch:{$eq:new a(e)}}}).exec()}))}updateRoom(e,t,n){return i(this,void 0,void 0,(function*(){return(yield o.RoomBaseModel.updateOne({_id:e,participants:{$elemMatch:{$eq:new a(t)}}},{name:n}).exec()).modifiedCount>0&&e}))}}},6304:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContactSchema=void 0;const i=n(1185);t.ContactSchema=new i.Schema({phones:{type:[String],required:!0},emails:{type:[String],required:!0},social:{type:[String]}})},4448:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DepartmentSchema=void 0;const r=n(1185),o=n(6304),a=n(4919),s=i(n(3464)),u=new r.Schema({name:{type:String,required:!0,es_index:!0},dean:{type:r.Schema.Types.ObjectId,required:!0},description:{type:String},contact:{type:o.ContactSchema,required:!0},details:{type:[a.DetailSchema],required:!0},image:{type:String,required:!0},creator:{type:r.Schema.Types.ObjectId,required:!0}});t.DepartmentSchema=u,u.plugin(s.default)},4919:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DetailSchema=void 0;const i=n(1185);t.DetailSchema=new i.Schema({title:{type:String,required:!0},content:{type:[String],required:!0}})},9125:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FavoriteSchema=t.EFavouriteType=void 0;const i=n(1185);var r;!function(e){e.TEACHER="teacher",e.LAB="lab",e.DEPARTMENT="department"}(r||(t.EFavouriteType=r={}));const o=new i.Schema({name:{type:String,required:!0},type:{type:String,required:!0},ref:{type:i.Schema.Types.ObjectId}},{timestamps:!0});t.FavoriteSchema=o},7581:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LabSchema=void 0;const r=n(1185),o=n(6304),a=n(4919),s=i(n(3464)),u=new r.Schema({name:{type:String,required:!0,es_index:!0},dean:{type:r.Schema.Types.ObjectId,required:!0},description:{type:String},contact:{type:o.ContactSchema,required:!0},details:{type:[a.DetailSchema],required:!0},image:{type:String,required:!0},creator:{type:r.Schema.Types.ObjectId,required:!0},department:{type:r.Schema.Types.ObjectId,required:!0}});t.LabSchema=u,u.plugin(s.default)},2045:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSchema=t.MESSAGE_TYPES=void 0;const i=n(1185),r=n(5355),o=n(6820);var a,s=i.Schema.Types.ObjectId;!function(e){e.TEXT="text",e.IMAGE="image",e.DELETED="deleted"}(a||(t.MESSAGE_TYPES=a={})),t.MessageSchema=new i.Schema({message:{type:String,require:!0},type:{type:String,default:()=>a.TEXT},createdBy:{type:s,required:!0,ref:o.UserBaseModel},seenBy:[r.SeenSchema]},{timestamps:!0})},6638:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OutstandingSchema=t.EOutstandingType=void 0;const i=n(1185),r=n(6820);var o;!function(e){e.TEACHER="teacher",e.DEPARTMENT="department",e.LAB="lab"}(o||(t.EOutstandingType=o={}));const a=new i.Schema({image:{type:String,required:!0},ref:{type:i.Schema.Types.ObjectId,required:!0},creator:{type:i.Schema.Types.ObjectId,ref:r.UserBaseModel},type:{type:String,required:!0}},{timestamps:!0});t.OutstandingSchema=a},9978:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSchema=void 0;const r=i(n(1185));var o=r.default.Types.ObjectId;t.RoomSchema=new r.default.Schema({participants:[{type:o,required:!0}],initiator:{type:o,required:!0},name:String,room_type:{type:String,required:!0}},{timestamps:!0})},5355:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SeenSchema=void 0;const i=n(1185);var r=i.Schema.Types.ObjectId;t.SeenSchema=new i.Schema({uid:{type:r,required:!0,ref:"User"},readAt:{type:Date,default:new Date}},{timestamps:!1})},4315:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=n(1185),r=new i.Schema({name:{type:String,required:!0},user:{type:i.Schema.Types.ObjectId,required:!0},department:{type:i.Schema.Types.ObjectId,required:!0},creator:{type:i.Schema.Types.ObjectId,required:!0}},{timestamps:!0});t.default=r},1868:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TeacherSchema=void 0;const r=n(1185),o=n(6304),a=n(4919),s=i(n(3464)),u=n(1217),c=n(6479),d=new r.Schema({department:{type:r.Schema.Types.ObjectId,ref:c.DepartmentBaseModel},lab:{type:r.Schema.Types.ObjectId,ref:u.LabBaseModel},name:{type:String,required:!0,es_indexed:!0},description:{type:String},awards:{type:[r.Schema.Types.ObjectId]},contact:{type:o.ContactSchema},details:{type:[a.DetailSchema]},image:{type:String},creator:{type:r.Schema.Types.ObjectId,required:!0},user:{type:r.Schema.Types.ObjectId,required:!0}});t.TeacherSchema=d,d.plugin(s.default)},9372:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setTokenIndex=t.schema=void 0;const r=n(9818),o=n(7773);t.schema={"$.token":{type:o.SchemaFieldTypes.TEXT,AS:"token"},"$.uid":{type:o.SchemaFieldTypes.TEXT,AS:"uid"}},t.setTokenIndex=function(){return i(this,void 0,void 0,(function*(){try{yield r.redis.ft.create("idx:token",t.schema,{ON:"JSON",PREFIX:"token_"})}catch(e){"Index already exists"===e.message?console.log("Index idx:token exists already, skipped creation."):console.error(e)}}))}},5102:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=n(1185),r=n(9125),o=new i.Schema({username:{type:String,required:!0,unique:!0,index:!0},password:{type:String,required:!0},role:{type:String,required:!0},version:{type:Number,required:!0},email:{type:String,unique:!0,index:!0},creator:{type:i.Schema.Types.ObjectId},name:{type:String,required:!0},favorites:{type:[r.FavoriteSchema],required:!0}});t.default=o},7315:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1778);t.default=class{static create(e){return i(this,void 0,void 0,(function*(){const{name:t,user:n,department:i,creator:o}=e;return(yield r.StudentBaseModel.create({name:t,user:n,department:i,creator:o}))._id.toString()}))}static delete(e){return i(this,void 0,void 0,(function*(){return(yield r.StudentBaseModel.deleteOne({user:e}).exec()).acknowledged}))}static update(e,t){return i(this,void 0,void 0,(function*(){const{name:n,user:i,department:o}=t;return(yield r.StudentBaseModel.updateOne({user:e},{name:n,user:i,department:o})).acknowledged}))}static get(e){return i(this,void 0,void 0,(function*(){return yield r.StudentBaseModel.find({user:{$in:e}}).exec()}))}}},9660:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18);t.default=class{static create(e){return i(this,void 0,void 0,(function*(){const{name:t,lab:n,department:i,description:o,awards:a,details:s,contact:u,image:c,creator:d,user:l}=e;return(yield r.TeacherBaseModel.create({name:t,lab:n,department:i,description:o,awards:a,details:s,contact:u,image:c,creator:d,user:l}))._id.toString()}))}static delete(e){return i(this,void 0,void 0,(function*(){return(yield r.TeacherBaseModel.deleteOne({user:e}).exec()).acknowledged}))}static update(e,t){return i(this,void 0,void 0,(function*(){const{department:n,lab:i,description:o,details:a,contact:s,image:u}=t;return(yield r.TeacherBaseModel.updateOne({user:e},{department:n,lab:i,description:o,details:a,contact:s,image:u})).acknowledged}))}static search(e){return i(this,void 0,void 0,(function*(){return(yield r.TeacherBaseModel.search({match:{name:{query:e,fuzziness:"auto",fuzzy_transpositions:!0}}},{hydrate:!0,hydrateOptions:{select:"name _id"}})).body.hits.hydrated}))}static get(e){return i(this,void 0,void 0,(function*(){return yield r.TeacherBaseModel.find({user:{$in:e}}).exec()}))}}},4947:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(9818),o=n(4816);t.default=new class{insertRefreshToken(e,t,n){return i(this,void 0,void 0,(function*(){if(yield r.redis.set((0,o.getKey)(t,o.NameType.USER_VERSION),0,{NX:!0}),"OK"!==(yield r.redis.json.set((0,o.getKey)(e,o.NameType.TOKEN),"$",{uid:t,token:e}))||"OK"!==(yield r.redis.set((0,o.getKey)(t,o.NameType.USER_ROLE),n)))throw new Error("Unable to add refresh token")}))}getRefreshToken(e){return i(this,void 0,void 0,(function*(){return yield r.redis.json.get((0,o.getKey)(e,o.NameType.TOKEN))}))}deleteRefreshToken(e){return i(this,void 0,void 0,(function*(){const t=yield r.redis.ft.search("idx:token",`@uid:"${e}"`);t&&(yield Promise.all(t.documents.map((e=>r.redis.json.del(e.id)))))}))}updateVersion(e){return i(this,void 0,void 0,(function*(){if(!r.redis.incr((0,o.getKey)(e,o.NameType.USER_VERSION)))throw new Error("Unable to update version")}))}getVersion(e){return i(this,void 0,void 0,(function*(){return yield r.redis.get((0,o.getKey)(e,o.NameType.USER_VERSION))}))}getRole(e){return i(this,void 0,void 0,(function*(){return yield r.redis.get((0,o.getKey)(e,o.NameType.USER_ROLE))}))}}},5805:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(6820),u=o(n(8432));t.default=class{static validateUID(e){return a(this,void 0,void 0,(function*(){const t=Array.from(new Set(e)),n=(yield s.UserBaseModel.find({_id:{$in:t}},{_id:1}).exec()).map((e=>e._id.toString()));return t.every((e=>n.includes(e)))}))}static getUsers(e){return a(this,void 0,void 0,(function*(){const t=yield s.UserBaseModel.find({_id:{$in:e}},{email:!0,username:!0,_id:!0,role:1,name:1}).exec();if(t)return t.map((e=>{const{username:t,_id:n,email:i,role:r}=e;return{username:t,uid:n,email:i,role:r}}))}))}static create(e,t){return a(this,void 0,void 0,(function*(){const{username:n,role:i,name:r}=t;return(yield s.UserBaseModel.create({username:n,role:i,creator:e,name:r,version:0,favorites:[],email:n+"@vnu.edu.vn",password:yield u.hash("123456789",10)}))._id.toString()}))}static delete(e){return a(this,void 0,void 0,(function*(){return(yield s.UserBaseModel.deleteOne({_id:e})).acknowledged}))}static addFavorite(e,t){return a(this,void 0,void 0,(function*(){return(yield s.UserBaseModel.updateOne({_id:e},{$push:{favorites:{name:t.name,ref:t.ref,type:t.type}}})).acknowledged}))}static getFavourites(e){return a(this,void 0,void 0,(function*(){const t=yield s.UserBaseModel.findOne({_id:e},{favorites:1}).exec();return t?t.favorites:[]}))}}},8479:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(8961));t.default=function(e){e.use("/v1",r.default)}},9413:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(6860)),o=i(n(6464)),a=n(322),s=n(944),u=r.default.Router();u.post("/login",o.default.login),u.post("/logout",[a.checkJWT],o.default.logout),u.post("/create",[a.checkJWT,s.checkRole.bind({role:["admin"]})],o.default.create),u.delete("/:id",[a.checkJWT],s.checkRole.bind({role:["admin"]}),o.default.delete),t.default=u},9171:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(8665)),o=i(n(6319)),a=n(322),s=(0,n(6860).Router)();s.post("/room",[a.checkJWT],r.default.createRoom),s.put("/room/:roomID",[a.checkJWT],r.default.updateRoomName),s.delete("/room/:roomID",[a.checkJWT],r.default.deleteRoom),s.post("/msg",[a.checkJWT],o.default.createMessage),t.default=s},4408:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(8964)),o=n(322),a=n(944),s=(0,n(6860).Router)();s.post("/",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.create),s.delete("/:id",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.delete),t.default=s},8961:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6860),o=i(n(9413)),a=i(n(9171)),s=i(n(8114)),u=i(n(4408)),c=i(n(6785)),d=i(n(7471)),l=i(n(496)),f=(0,r.Router)();f.use("/chat",a.default),f.use("/auth",o.default),f.use("/outstanding",s.default),f.use("/department",u.default),f.use("/lab",c.default),f.use("/search",d.default),f.use("/me",l.default),t.default=f},6785:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1329)),o=n(322),a=n(944),s=(0,n(6860).Router)();s.post("/",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.create),s.delete("/:id",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.delete),t.default=s},496:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(4107)),o=n(322),a=(0,n(6860).Router)();a.get("/",[o.checkJWT],r.default.getProfile),a.get("/favourite",[o.checkJWT],r.default.getFavorite),a.post("/favourite",[o.checkJWT],r.default.addFavorite),t.default=a},8114:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(4340)),o=n(322),a=n(944),s=(0,n(6860).Router)();s.post("/",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.create),s.delete("/:id",[o.checkJWT,a.checkRole.bind({role:["admin"]})],r.default.delete),t.default=s},7471:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(7782)),o=n(322),a=(0,n(6860).Router)();a.get("/",[o.checkJWT],r.default.search),t.default=a},2790:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.EUserRole=void 0,function(e){e.ADMIN="admin",e.TEACHER="teacher",e.STUDENT="student"}(n||(t.EUserRole=n={}))},5417:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InputError=void 0;class n extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,n.prototype),this.field=t}}t.InputError=n},7797:function(e,t,n){var i=this&&this.__rest||function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.generate_password=t.generateResetToken=t.generateToken=t.generate_uid=void 0;const o=n(9344),a=r(n(5343)),s=n(1633);function u(e,t){return Math.floor(Math.random()*(t-e))+e}t.generate_uid=function(e=8){return e=e>0?e:8,[...new Array(e)].map((()=>u(0,9).toString())).join("")},t.generateToken=function(e,t){const n=e,{iat:r,exp:u}=n,c=i(n,["iat","exp"]);return{accessToken:(0,o.sign)(c,a.default.JWT_KEY,s.JWTTokenOpt),refreshToken:t&&(0,o.sign)(c,a.default.JWT_REFRESH_KEY,s.JWTRefreshOpt)}},t.generateResetToken=function(e){const t=e,{iat:n,exp:r}=t,u=i(t,["iat","exp"]);return(0,o.sign)(u,a.default.JWT_RESET_KEY,s.JWTResetOpt)},t.generate_password=function(e=8){e=e>0?e:8;return[...new Array(e)].map((()=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"[u(0,61)])).join("")}},9412:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417);t.default=function(e,t){return i(this,void 0,void 0,(function*(){try{yield t()}catch(t){console.log(t),t instanceof r.InputError?e.status(400).json({message:t.message,name:t.field}):e.sendStatus(500)}}))}},4816:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.getKey=t.NameType=void 0,function(e){e[e.USER_VERSION=0]="USER_VERSION",e[e.USER_ROLE=1]="USER_ROLE",e[e.TOKEN=2]="TOKEN"}(n||(t.NameType=n={})),t.getKey=function(e,t){return t===n.USER_VERSION&&e+"_v"||t===n.USER_ROLE&&e+"_r"||t===n.TOKEN&&"token_"+e||e}},4747:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417),o=i(n(3389));class a extends o.default{static checkUsername(e,t){if(e){if(e.length<3||e.length>50)throw new r.InputError("Username có độ dài từ 3 đến 50 ký tự","username")}else if(!t)throw new r.InputError("Must include username","username")}static checkPassword(e){if(!e||e.length<8||e.length>50)throw new r.InputError("Mật khẩu có độ dài từ 8 đến 50 ký tự","password")}static validateLogin(e){this.checkUsername(e.username),this.checkPassword(e.password)}}t.default=a},3389:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=n(2790),r=n(5417);t.default=class{static checkName(e,t){if(e){if(!e||e.length<5)throw new r.InputError("Invalid name","name")}else if(!t)throw new r.InputError("Must include name","name")}static checkFile(e,t){if(e);else if(!t)throw new r.InputError("Must include a file","file")}static checkId(e,t){if(e){if(24!=e.length)throw new r.InputError("Invalid id","id")}else if(!t)throw new r.InputError("Must include id","id")}static checkEmail(e,t){if(e){if(!/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e))throw new r.InputError("Email không hợp lệ","email")}else if(!t)throw new r.InputError("Must include email","email")}static checkRole(e,t){if(e){if(!Object.values(i.EUserRole).includes(e))throw new r.InputError("Invalid role","role")}else if(!t)throw new r.InputError("Must include role","role")}static checkPhone(e,t){if(e){if(10!==e.length||!e.startsWith("0"))throw new r.InputError("Invalid phone number","phone")}else if(!t)throw new r.InputError("Must include phone number","phone")}static checkLink(e,t){if(e){if(!/[(http(s)?):\/\/(www\.)?a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/.test(e))throw new r.InputError("Link không hợp lệ","link")}else if(!t)throw new r.InputError("Must include link","link")}static checkContact(e,t){if(e){if(!e.phones||!Array.isArray(e.phones))throw new r.InputError("Contact phones must be an array","contact.phones");if(!e.emails||!Array.isArray(e.emails))throw new r.InputError("Contact emails must be an array","contact.emails");if(e.social&&!Array.isArray(e.social))throw new r.InputError("Contact social must be an array","contact.social");e.phones.forEach((e=>this.checkPhone(e))),e.emails.forEach((e=>this.checkEmail(e))),e.social&&e.social.forEach((e=>this.checkLink(e)))}else if(!t)throw new r.InputError("Must include contact","contact")}static checkDetail(e,t){if(e){if(!Array.isArray(e))throw new r.InputError("Detail must be an array","detail");e.forEach((e=>{if(this.checkName(e.title),!Array.isArray(e.content))throw new r.InputError("Detail content must be an array","detail.content");e.content.forEach((e=>this.checkName(e)))}))}else if(!t)throw new r.InputError("Must include details","details")}}},4216:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=n(2045),r=n(5417);t.default=new class{validateRoomID(e){if(!e)throw new r.InputError("Must provide roomID","participants");return!0}validateCreateRoom(e){if(!e.participants)throw new r.InputError("Must provide participants","participants");if(!Array.isArray(e.participants))throw new r.InputError("Participants must be an array","participants")}validateDeleteRoom(e){this.validateRoomID(e.roomID)}validateGetRoom(e){this.validateRoomID(e.roomID)}validateUpdateRoom(e){this.validateRoomID(e.roomID)}validateCreateMessage(e){if(this.validateRoomID(e.roomID),!Object.values(i.MESSAGE_TYPES).includes(e.type))throw new Error("Invalid message type",{cause:"type"})}}},9416:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(3389));class o extends r.default{static validateCreate(e){this.checkName(e.name),this.checkId(e.dean),this.checkFile(e.image),this.checkContact(e.contact),this.checkDetail(e.details)}static validateDelete(e){this.checkId(e.id)}}t.default=o},8937:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(3389));class o extends r.default{static validateCreate(e){this.checkName(e.name),this.checkId(e.dean),this.checkFile(e.image),this.checkContact(e.contact),this.checkDetail(e.details),this.checkId(e.department)}static validateDelete(e){this.checkId(e.id)}}t.default=o},1529:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(3389)),o=n(9125),a=n(5417);class s extends r.default{static checkFavouriteType(e,t){if(e){if(!Object.values(o.EFavouriteType).includes(e))throw new a.InputError("Invalid favourite type","type")}else if(!t)throw new a.InputError("Must include favorite type","type")}static validateAddFavourite(e){this.checkId(e.ref),this.checkFavouriteType(e.type),this.checkName(e.name)}}t.default=s},4539:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417),o=i(n(3389)),a=n(6638);class s extends o.default{static checkOutstandingType(e,t){if(e){if(!Object.values(a.EOutstandingType).includes(e))throw new r.InputError("Invalid outstanding type","type")}else if(!t)throw new r.InputError("Must included outstanding type","type")}static validateCreate(e){this.checkFile(e.image),this.checkId(e.ref),this.checkOutstandingType(e.type)}static validateDelete(e){this.checkId(e.id)}}t.default=s},8047:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(3389));class o extends r.default{static validateCreate(e){this.checkId(e.user),this.checkId(e.department),this.checkName(e.name)}static validateUpdate(e){}static validateDelete(e){this.checkId(e.id)}}t.default=o},7649:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417),o=i(n(3389));class a extends o.default{static checkAwards(e,t){if(e){if(!Array.isArray(e))throw new r.InputError("Awards must be an array","awards");e.forEach((e=>this.checkId(e)))}else if(!t)throw new r.InputError("Must include a list of awards","awards")}static validateCreate(e){this.checkName(e.name),this.checkId(e.user),this.checkId(e.lab,!0),this.checkId(e.department,!0),this.checkAwards(e.awards,!0),this.checkContact(e.contact,!0),this.checkDetail(e.details,!0),this.checkFile(e.image,!0)}static validateUpdate(e){this.checkId(e.id),this.checkId(e.lab,!0),this.checkId(e.department,!0),this.checkContact(e.contact,!0),this.checkDetail(e.details,!0),this.checkFile(e.image,!0)}static validateDelete(e){this.checkId(e.id)}}t.default=a},203:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417),o=i(n(3389));class a extends o.default{static checkUsername(e,t){if(e){if(e.length<3||e.length>50)throw new r.InputError("Username có độ dài từ 3 đến 50 ký tự","username")}else if(!t)throw new r.InputError("Must include username","username")}static validateCreate(e){this.checkName(e.name),this.checkUsername(e.username),this.checkRole(e.role)}static validateDelete(e){this.checkId(e.id)}}t.default=a},8432:e=>{e.exports=require("bcryptjs")},3518:e=>{e.exports=require("cloudinary")},9710:e=>{e.exports=require("cookie-parser")},3582:e=>{e.exports=require("cors")},5142:e=>{e.exports=require("dotenv")},6860:e=>{e.exports=require("express")},6674:e=>{e.exports=require("express-fileupload")},7806:e=>{e.exports=require("helmet")},9344:e=>{e.exports=require("jsonwebtoken")},3464:e=>{e.exports=require("mongoosastic")},1185:e=>{e.exports=require("mongoose")},9470:e=>{e.exports=require("morgan")},7773:e=>{e.exports=require("redis")},3952:e=>{e.exports=require("socket.io")},8849:e=>{e.exports=require("node:http")},1017:e=>{e.exports=require("path")}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.c=t,n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n(n.s=3607)})();