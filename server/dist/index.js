(()=>{"use strict";var e={4742:(e,t)=>{function n(){return Object.assign({},t.cookieSecureOption)}Object.defineProperty(t,"__esModule",{value:!0}),t.withSession=t.withAge=t.cookieSecureOption=void 0,t.cookieSecureOption={httpOnly:!0,secure:!0},t.withAge=function(e){return void 0===e?n():Object.assign(Object.assign({},t.cookieSecureOption),{maxAge:e})},t.withSession=n},2009:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.connect=void 0;const r=i(n(1185)),a=i(n(5343)),{MG_HOST:s,MG_PORT:u,MG_NAME:d,MG_USERNAME:c,MG_PASSWORD:l,MONGODB_URI:f}=a.default;r.default.set("strictQuery",!0);const p=f||`mongodb+srv://${c}:${l}@${s}/${d}?retryWrites=true&w=majority`;t.connect=()=>o(void 0,void 0,void 0,(function*(){return r.default.connect(p)}))},5343:function(e,t,n){var o=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.env=void 0;const r=n(5142),a=i(n(1017)),s=process.env,{NODE_ENV:u}=s,d=o(s,["NODE_ENV"])||{},c=(0,r.config)("dev"===u?{path:a.default.resolve(process.cwd(),".env.dev")}:void 0).parsed;t.env="production",t.default=Object.assign(Object.assign(Object.assign({},c),{ENV:"production"}),d)},1633:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JWTResetOpt=t.JWTRefreshOpt=t.JWTTokenOpt=void 0;const i=o(n(5343));t.JWTTokenOpt={expiresIn:"dev"===i.default.ENV?"10s":"3600s"},t.JWTRefreshOpt={expiresIn:"dev"===i.default.ENV?"600s":"86400s"},t.JWTResetOpt={expiresIn:"dev"===i.default.ENV?"180s":"300s"}},6168:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(5184)),u=a(n(5343)),d=s.createTransport({pool:!0,service:u.default.MAIL_SERVICE,auth:{user:u.default.MAIL_USER,pass:u.default.MAIL_PASSWORD}});t.default=d},9818:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startup=t.setupRedisIndex=t.redis=void 0;const r=n(7773),a=i(n(5343)),s=n(9372);function u(){return o(this,void 0,void 0,(function*(){yield(0,s.setTokenIndex)()}))}t.redis=(0,r.createClient)({password:a.default.RD_PASSWORD,socket:{host:a.default.RD_HOST,port:Number(a.default.RD_PORT)}}),t.setupRedisIndex=u,t.startup=function(){return o(this,void 0,void 0,(function*(){yield t.redis.connect(),yield u()}))}},6464:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(4742),a=n(7797),s=i(n(9412)),u=i(n(4747)),d=i(n(5215)),c=i(n(4947)),l=n(3713),f=i(n(5343));t.default=class{static login(e,t){return o(this,void 0,void 0,(function*(){const n=e.body;console.log(n),yield(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateLogin(n);const e=yield d.default.findUserByPassword(n.username,n.password);if(e){const o=(yield c.default.getVersion(e.uid))||"0",i=(0,a.generateToken)(Object.assign(Object.assign({},e),{version:o,remember:n.remember}),!0);yield c.default.insertRefreshToken(i.refreshToken,e.uid,e.role),function(e,t,n,o){o&&e.cookie("refresh_token",o,(0,r.withAge)(864e5)),e.status(200).cookie("token",n,(0,r.withAge)(t?36e5:void 0)).json({message:"success",data:{accessToken:n,refreshToken:o}}).send()}(t,n.remember,i.accessToken,i.refreshToken)}else t.status(401).json({message:"Invalid username or password",name:"password"})}))))}))}static logout(e,t){return o(this,void 0,void 0,(function*(){const e=t.locals.user;yield(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){c.default.deleteRefreshToken(e.uid),c.default.updateVersion(e.uid),t.cookie("token",null,(0,r.withAge)(0)),t.cookie("refresh_token",null,(0,r.withAge)(0)),t.sendStatus(200)}))))}))}static requestReset(e,t){return o(this,void 0,void 0,(function*(){const n=e.body;console.log(n),yield(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateRequestReset(n);const e=yield d.default.findUserByInfo(n);if(e){const{username:n,uid:o}=e,i=(0,a.generateResetToken)({username:n,uid:o,role:"admin",version:"0",remember:!1});yield(0,l.sendForgetPasswordMail)(e,i),t.status(200).json({message:"Email đã được gửi thành công tới "+e.email})}else t.status(400).json({message:"Không tồn tại email",name:"email"})}))))}))}static verifyReset(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user.username,o=1e3*t.locals.user.exp,i=Math.floor((o-(new Date).getTime())/1e3);t.cookie("token",e.query.token,(0,r.withAge)(18e4)).redirect(f.default.FRONTEND+"/resetpassword?ttl="+i+"&user="+n)}))}static resetPassword(e,t){return o(this,void 0,void 0,(function*(){const n=e.body;yield(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateReset(n);const e=t.locals.user;yield d.default.updatePassword(e.uid,n.password),t.json({message:"Password changed successfully"})}))))}))}static create(e,t){return o(this,void 0,void 0,(function*(){const n=e.body,i=t.locals.user;(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateCreate(n),yield d.default.createUser(n.username,n.name,i.uid,n.major,n.role),t.json({message:"User created successfully"})}))))}))}}},6319:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(7035)),a=i(n(6362)),s=i(n(9412)),u=i(n(4216));t.default=new class{createMessage(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,i=(e.params.roomID,e.body);(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){if(u.default.validateCreateMessage(i),!(yield a.default.getRoom(i.roomID,n.uid)))throw new Error("Invalid roomID",{cause:"roomID"});yield r.default.createMessage(i.roomID,n.uid,i.message,i.type),t.json({message:"success"})}))))}))}}},4340:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(8101)),a=i(n(9412)),s=i(n(4539));t.default=class{static create(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,i=e.body;(0,a.default)(t,(()=>o(this,void 0,void 0,(function*(){s.default.validateCreate(i);const e=yield r.default.create(i.image,i.ref,i.type,n.uid);t.status(200).send({message:"Success",data:{id:e}})}))))}))}static delete(e,t){return o(this,void 0,void 0,(function*(){const n=e.params.id;(0,a.default)(t,(()=>o(this,void 0,void 0,(function*(){s.default.validateDelete({id:n}),r.default.delete(n)}))))}))}static update(e,t){return o(this,void 0,void 0,(function*(){const n=e.params.id,i=t.locals.user,u=e.body;(0,a.default)(t,(()=>o(this,void 0,void 0,(function*(){s.default.validateUpdate(Object.assign({id:n},u)),r.default.update(n,u.image,u.ref,i.uid)}))))}))}}},8665:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(6362)),a=i(n(5805)),s=i(n(9412)),u=i(n(4216));t.default=new class{createRoom(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,i=e.body;(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){if(u.default.validateCreateRoom(i),!(yield a.default.validateUID(i.participants)))return void t.status(400).json({message:"Invalid participant IDs"});const e=yield r.default.findByParticipants(i.participants);if(e)t.status(200).json({message:"The room has been created previously",data:{is_new:!1,room_id:e._id}});else{const e=yield r.default.createRoom(n.uid,i.participants,i.name);t.status(200).json({message:"The room has been created successfully",data:{is_new:!0,room_id:e._id}})}}))))}))}deleteRoom(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,i=e.params.roomID;(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateDeleteRoom({roomID:i}),(yield r.default.deleteRoom(i,n.uid))?t.status(200).json({message:"The room has been deleted successfully",data:{roomID:i}}):t.status(400).json({message:"You have not permission to delete this room",data:{roomID:i}})}))))}))}getRoomByID(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,i=e.params.roomID;(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateGetRoom({roomID:i});const e=yield r.default.getRoom(i,n.uid);t.json({message:"success",data:{room:e}})}))))}))}updateRoomName(e,t){return o(this,void 0,void 0,(function*(){const n=t.locals.user,{name:i}=e.body,a=e.params.roomID;(0,s.default)(t,(()=>o(this,void 0,void 0,(function*(){u.default.validateUpdateRoom({roomID:a});const e=yield r.default.updateRoom(a,n.uid,i);t.json({message:"success",data:e})}))))}))}}},3607:function(e,t,n){e=n.nmd(e);var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=s(n(6860)),d=r(n(3582)),c=s(n(9470)),l=s(n(9710)),f=n(3952),p=n(8849),h=s(n(8479)),v=s(n(5343)),m=r(n(2009)),_=r(n(9818)),y=n(7520),g=s(n(6950)),w=(0,u.default)(),O=v.default.PORT,b=(0,p.createServer)(w);w.use((0,c.default)("tiny")),w.use(u.default.json()),w.use(u.default.urlencoded({extended:!0})),w.use((0,l.default)()),w.use(d.default({origin:v.default.CORS_ORIGIN,credentials:!0,methods:["GET","PUT","POST","DELETE"],optionsSuccessStatus:200})),(0,h.default)(w),w.use("/graphql/",(0,y.graphqlHTTP)({schema:g.default,graphiql:!0})),new f.Server(b).on("connection",(e=>{console.log("a user connected"),e.emit("test","Hello Testing event!")})),n.c[n.s]===e&&b.listen(O,(()=>a(void 0,void 0,void 0,(function*(){yield _.startup(),console.log("📕 [database]: Connected to redis"),yield m.connect(),console.log("📒 [database]: Connected to mysql"),console.log(`✅ [server]: Server is running at http://localhost:${O}`)})))),t.default=w},322:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkJWT=void 0;const u=r(n(9344)),d=s(n(5343)),c=n(5326),l=s(n(4947));t.checkJWT=function(e,t,n){return a(this,void 0,void 0,(function*(){const o=this&&"query"===this.tokenOn?e.query.token:e.cookies.token;if(!o)return t.sendStatus(401);try{const e=u.verify(o,d.default.JWT_KEY),i=yield l.default.getVersion(e.uid);if(i&&i!==e.version)return t.sendStatus(401);t.locals.user=e,n()}catch(o){if(!(o instanceof u.TokenExpiredError))return console.log(o),t.sendStatus(401);(0,c.checkRWT)(e,t,n)}}))}},5326:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkRWT=void 0;const u=r(n(9344)),d=s(n(5343)),c=n(7797),l=s(n(4947)),f=n(4742),p=s(n(9412));t.checkRWT=function(e,t,n){return a(this,void 0,void 0,(function*(){const o=e.cookies.refresh_token;(0,p.default)(t,(()=>a(this,void 0,void 0,(function*(){if(!o||!(yield l.default.getRefreshToken(o)))return t.sendStatus(401);try{const e=u.verify(o,d.default.JWT_REFRESH_KEY);e.role=yield l.default.getRole(e.uid),e.version=yield l.default.getVersion(e.uid);const i=(0,c.generateToken)(e,!0);yield l.default.insertRefreshToken(i.refreshToken,e.uid,e.role),t.cookie("refresh_token",i.refreshToken,(0,f.withAge)(864e5)).cookie("token",i.accessToken,(0,f.withAge)(e.remember?36e5:void 0)).locals.user=e,n()}catch(e){console.log(e),t.sendStatus(401)}}))))}))}},6990:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkReset=void 0;const s=r(n(9344)),u=a(n(5343));t.checkReset=function(e,t,n){const o=e.query.token||e.cookies.token;if(!o)return t.sendStatus(401);try{const e=s.verify(o,u.default.JWT_RESET_KEY);t.locals.user=e,n()}catch(e){return console.log(e),t.sendStatus(401)}}},944:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,o){return n(this,void 0,void 0,(function*(){const e=this?this:"admin";t.locals.user.role===e?o():t.sendStatus(401)}))}},5215:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(8432)),u=n(6820);t.default=new class{findUserByPassword(e,t){return a(this,void 0,void 0,(function*(){const n=yield u.UserBaseModel.findOne({username:e},{_id:1,role:1,username:1,password:1}).exec();if(!n)return;const{_id:o,username:i,password:r,role:a}=n;return t?(yield s.compare(t,r))&&{uid:o.toString(),username:i,role:a}:void 0}))}findUserByInfo(e){return a(this,void 0,void 0,(function*(){const t=yield u.UserBaseModel.findOne({$or:[{username:e.username},{email:e.email},{_id:e.uid}]},{email:!0,username:!0,phone:!0,_id:!0}).exec();if(!t)return;const{username:n,_id:o,email:i}=t;return{username:n,uid:o.toString(),email:i}}))}updatePassword(e,t){return a(this,void 0,void 0,(function*(){yield u.UserBaseModel.updateOne({_id:e},{password:yield s.hash(t,10)}).exec()}))}createUser(e,t,n,o,i){return a(this,void 0,void 0,(function*(){return(yield u.UserBaseModel.create({username:e,name:t,initiator:n,major:o,role:i,email:e+"@vnu.edu.vn",password:yield s.hash("12345678",10)}))._id}))}}},3069:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageBaseModel=void 0;const o=n(1185),i=n(2045);t.MessageBaseModel=(0,o.model)("Message",i.MessageSchema)},2649:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OutstandingBaseModel=void 0;const o=n(1185),i=n(6638);t.OutstandingBaseModel=(0,o.model)("Outstanding",i.OutstandingSchema)},7964:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RoomBaseModel=void 0;const o=n(1185),i=n(9978);t.RoomBaseModel=(0,o.model)("ChatRoom",i.RoomSchema)},6820:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UserBaseModel=void 0;const o=n(1185),i=n(5102);t.UserBaseModel=(0,o.model)("User",i.UserSchema)},7035:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(2045),r=n(3069);t.default=new class{createMessage(e,t,n,a=i.MESSAGE_TYPES.TEXT){return o(this,void 0,void 0,(function*(){yield r.MessageBaseModel.create({roomID:e,message:n,createdBy:t,type:a,seenBy:{uid:t}})}))}}},8101:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(2649);t.default=class{static create(e,t,n,r){return o(this,void 0,void 0,(function*(){return(yield i.OutstandingBaseModel.create({image:e,ref:t,initiator:r,type:n}))._id}))}static update(e,t,n,r){return o(this,void 0,void 0,(function*(){return(yield i.OutstandingBaseModel.updateOne({_id:e},{image:t,ref:n,initiator:r}).exec()).acknowledged}))}static delete(e){return o(this,void 0,void 0,(function*(){return(yield i.OutstandingBaseModel.deleteOne({_id:e}).exec()).acknowledged}))}}},6362:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(7964);var a=i(n(1185)).default.Types.ObjectId;t.default=new class{findByParticipants(e){return o(this,void 0,void 0,(function*(){return(yield r.RoomBaseModel.findOne({participants:{$size:e.length,$all:[...e]}}).exec())||void 0}))}createRoom(e,t,n){return o(this,void 0,void 0,(function*(){return t.push(e),yield r.RoomBaseModel.create({name:n,initiator:e,participants:t,room_type:t.length>2?"group":"P2P"})}))}deleteRoom(e,t){return o(this,void 0,void 0,(function*(){return(yield r.RoomBaseModel.deleteOne({_id:e,initiator:t}).exec()).deletedCount>0&&e}))}getRoom(e,t){return o(this,void 0,void 0,(function*(){return yield r.RoomBaseModel.findOne({_id:e,participants:{$elemMatch:{$eq:new a(t)}}}).exec()}))}getRoomHasUser(e){return o(this,void 0,void 0,(function*(){return yield r.RoomBaseModel.find({participants:{$elemMatch:{$eq:new a(e)}}}).exec()}))}updateRoom(e,t,n){return o(this,void 0,void 0,(function*(){return(yield r.RoomBaseModel.updateOne({_id:e,participants:{$elemMatch:{$eq:new a(t)}}},{name:n}).exec()).modifiedCount>0&&e}))}}},2045:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSchema=t.MESSAGE_TYPES=void 0;const o=n(1185),i=n(5355),r=n(6820);var a,s=o.Schema.Types.ObjectId;!function(e){e.TEXT="text",e.IMAGE="image",e.DELETED="deleted"}(a||(t.MESSAGE_TYPES=a={})),t.MessageSchema=new o.Schema({message:{type:String,require:!0},type:{type:String,default:()=>a.TEXT},createdBy:{type:s,required:!0,ref:r.UserBaseModel},seenBy:[i.SeenSchema]},{timestamps:!0})},6638:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OutstandingSchema=void 0;const i=n(1185),r=n(6820),a=o(n(3464));t.OutstandingSchema=new i.Schema({image:{type:String,required:!0},ref:{type:i.Schema.Types.ObjectId,required:!0},initiator:{type:i.Schema.Types.ObjectId,ref:r.UserBaseModel},type:{type:String,required:!0}},{timestamps:!0}),t.OutstandingSchema.plugin(a.default)},9978:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSchema=void 0;const i=o(n(1185));var r=i.default.Types.ObjectId;t.RoomSchema=new i.default.Schema({participants:[{type:r,required:!0}],initiator:{type:r,required:!0},name:String,room_type:{type:String,required:!0}},{timestamps:!0})},5355:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SeenSchema=void 0;const o=n(1185);var i=o.Schema.Types.ObjectId;t.SeenSchema=new o.Schema({uid:{type:i,required:!0,ref:"User"},readAt:{type:Date,default:new Date}},{timestamps:!1})},9372:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setTokenIndex=t.schema=void 0;const i=n(9818),r=n(7773);t.schema={"$.token":{type:r.SchemaFieldTypes.TEXT,AS:"token"},"$.uid":{type:r.SchemaFieldTypes.TEXT,AS:"uid"}},t.setTokenIndex=function(){return o(this,void 0,void 0,(function*(){try{yield i.redis.ft.create("idx:token",t.schema,{ON:"JSON",PREFIX:"token_"})}catch(e){"Index already exists"===e.message?console.log("Index idx:token exists already, skipped creation."):console.error(e)}}))}},5102:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.UserSchema=void 0;const a=r(n(1185));var s=a.default.Types.ObjectId;t.UserSchema=new a.Schema({username:{type:String,required:!0,unique:!0,index:!0},password:{type:String,required:!0},role:{type:String,required:!0},version:{type:Number,required:!0},email:{type:String,unique:!0,index:!0},name:{type:String,required:!0},major:{type:String,required:!0},teacher_profile:{type:s},created_by:{type:s}})},4947:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(9818),r=n(4816);t.default=new class{insertRefreshToken(e,t,n){return o(this,void 0,void 0,(function*(){if(yield i.redis.set((0,r.getKey)(t,r.NameType.USER_VERSION),0,{NX:!0}),"OK"!==(yield i.redis.json.set((0,r.getKey)(e,r.NameType.TOKEN),"$",{uid:t,token:e}))||"OK"!==(yield i.redis.set((0,r.getKey)(t,r.NameType.USER_ROLE),n)))throw new Error("Unable to add refresh token")}))}getRefreshToken(e){return o(this,void 0,void 0,(function*(){return yield i.redis.json.get((0,r.getKey)(e,r.NameType.TOKEN))}))}deleteRefreshToken(e){return o(this,void 0,void 0,(function*(){const t=yield i.redis.ft.search("idx:token",`@uid:"${e}"`);t&&(yield Promise.all(t.documents.map((e=>i.redis.json.del(e.id)))))}))}updateVersion(e){return o(this,void 0,void 0,(function*(){if(!i.redis.incr((0,r.getKey)(e,r.NameType.USER_VERSION)))throw new Error("Unable to update version")}))}getVersion(e){return o(this,void 0,void 0,(function*(){return yield i.redis.get((0,r.getKey)(e,r.NameType.USER_VERSION))}))}getRole(e){return o(this,void 0,void 0,(function*(){return yield i.redis.get((0,r.getKey)(e,r.NameType.USER_ROLE))}))}}},5805:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(6820);t.default=new class{validateUID(e){return o(this,void 0,void 0,(function*(){const t=Array.from(new Set(e)),n=(yield i.UserBaseModel.find({_id:{$in:t}},{_id:1}).exec()).map((e=>e._id.toString()));return t.every((e=>n.includes(e)))}))}getUsers(e){return o(this,void 0,void 0,(function*(){const t=yield i.UserBaseModel.find({_id:{$in:e}},{email:!0,username:!0,phone:!0,_id:!0,role:1}).exec();if(t)return t.map((e=>{const{username:t,_id:n,email:o,role:i}=e;return{username:t,uid:n,email:o,role:i}}))}))}}},8479:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(8961));t.default=function(e){e.use("/v1",i.default)}},9413:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(6860)),r=o(n(6464)),a=n(322),s=n(6990),u=o(n(944)),d=i.default.Router();d.post("/login",r.default.login),d.post("/logout",[a.checkJWT],r.default.logout),d.post("/reset",r.default.requestReset),d.get("/reset",[s.checkReset],r.default.verifyReset),d.put("/reset",[s.checkReset],r.default.resetPassword),d.post("/create",[a.checkJWT,u.default.bind("admin")],r.default.create),t.default=d},9171:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(8665)),r=o(n(6319)),a=n(322),s=(0,n(6860).Router)();s.post("/room",[a.checkJWT],i.default.createRoom),s.put("/room/:roomID",[a.checkJWT],i.default.updateRoomName),s.delete("/room/:roomID",[a.checkJWT],i.default.deleteRoom),s.post("/msg",[a.checkJWT],r.default.createMessage),t.default=s},8961:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(6860),r=o(n(9413)),a=o(n(9171)),s=o(n(8114)),u=(0,i.Router)();u.use("/chat",a.default),u.use("/auth",r.default),u.use("/outstanding",s.default),t.default=u},8114:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(4340)),r=n(322),a=o(n(944)),s=(0,n(6860).Router)();s.post("/",[r.checkJWT,a.default.bind("admin")],i.default.create),s.put("/:id",[r.checkJWT,a.default.bind("admin")],i.default.update),s.delete("/:id",[r.checkJWT,a.default.bind("admin")],i.default.delete),t.default=s},6950:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(7343),i=n(257),r=new o.GraphQLObjectType({name:"Query",description:"Root Query",fields:()=>({rooms:i.roomsQuery})}),a=new o.GraphQLSchema({query:r});t.default=a},257:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.roomsQuery=void 0;const r=n(7343),a=n(2634),s=i(n(6362));t.roomsQuery={type:(0,r.GraphQLList)(a.RoomGraph),description:"List all rooms satisfying filter.",args:{uid:{type:r.GraphQLString}},resolve:(e,t)=>o(void 0,void 0,void 0,(function*(){return t.uid?yield s.default.getRoomHasUser(t.uid):[]}))}},8819:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UserQueryMany=t.UserQuery=void 0;const r=n(7343),a=n(6797),s=i(n(5805));t.UserQuery={type:a.UserGraph,description:"User Query",resolve:(e,t)=>o(void 0,void 0,void 0,(function*(){return e.initiator?(yield s.default.getUsers([e.initiator]))[0]:null}))},t.UserQueryMany={type:(0,r.GraphQLList)(a.UserGraph),description:"User Query Many",resolve:(e,t)=>o(void 0,void 0,void 0,(function*(){return e.participants?yield s.default.getUsers([...e.participants]):[]}))}},2634:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RoomGraph=t.ERoomType=void 0;const o=n(7343),i=n(8819);t.ERoomType=new o.GraphQLEnumType({name:"RoomTypeEnum",description:"Room type enum",values:{P2P:{value:"P2P"},GROUP:{value:"Group"}}}),t.RoomGraph=new o.GraphQLObjectType({name:"RoomGraph",description:"Room Graph",fields:{participants:i.UserQueryMany,name:{type:o.GraphQLString},initiator:i.UserQuery,room_type:{type:t.ERoomType}}})},6797:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UserGraph=t.EUserRole=void 0;const o=n(7343);t.EUserRole=new o.GraphQLEnumType({name:"UserRoleEnum",description:"User Role Enum",values:{ADMIN:{value:"admin"},STUDENT:{value:"student"},TEACHER:{value:"teacher"}}}),t.UserGraph=new o.GraphQLObjectType({name:"UserGraph",description:"User Graph",fields:{username:{type:o.GraphQLString},role:{type:t.EUserRole},email:{type:o.GraphQLString},phone:{type:o.GraphQLString},uid:{type:o.GraphQLString}}})},5417:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InputError=void 0;class n extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,n.prototype),this.field=t}}t.InputError=n},7797:function(e,t,n){var o=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.generate_password=t.generateResetToken=t.generateToken=t.generate_uid=void 0;const r=n(9344),a=i(n(5343)),s=n(1633);function u(e,t){return Math.floor(Math.random()*(t-e))+e}t.generate_uid=function(e=8){return e=e>0?e:8,[...new Array(e)].map((()=>u(0,9).toString())).join("")},t.generateToken=function(e,t){const n=e,{iat:i,exp:u}=n,d=o(n,["iat","exp"]);return{accessToken:(0,r.sign)(d,a.default.JWT_KEY,s.JWTTokenOpt),refreshToken:t&&(0,r.sign)(d,a.default.JWT_REFRESH_KEY,s.JWTRefreshOpt)}},t.generateResetToken=function(e){const t=e,{iat:n,exp:i}=t,u=o(t,["iat","exp"]);return(0,r.sign)(u,a.default.JWT_RESET_KEY,s.JWTResetOpt)},t.generate_password=function(e=8){e=e>0?e:8;return[...new Array(e)].map((()=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"[u(0,61)])).join("")}},9412:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(5417);t.default=function(e,t){return o(this,void 0,void 0,(function*(){try{yield t()}catch(t){console.log(t),t instanceof i.InputError?e.status(400).json({message:t.message,name:t.field}):e.sendStatus(500)}}))}},4816:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.getKey=t.NameType=void 0,function(e){e[e.USER_VERSION=0]="USER_VERSION",e[e.USER_ROLE=1]="USER_ROLE",e[e.TOKEN=2]="TOKEN"}(n||(t.NameType=n={})),t.getKey=function(e,t){return t===n.USER_VERSION&&e+"_v"||t===n.USER_ROLE&&e+"_r"||t===n.TOKEN&&"token_"+e||e}},3713:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},a=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startup=t.sendForgetPasswordMail=t.sendMail=t.renderTemplate=void 0;const u=s(n(6168)),d=s(n(5343)),c=r(n(2097)),l=r(n(7147)),f=r(n(1017));function p(e,t,n){return a(this,void 0,void 0,(function*(){yield u.default.sendMail({from:`"${d.default.APP_NAME}" <${d.default.MAIL_USER}>`,to:e,subject:t,html:n})}))}t.renderTemplate=(e,t)=>{const n=f.join(f.resolve(),e),o=l.readFileSync(n,"utf-8").toString();return c.compile(o)(t)},t.sendMail=p,t.sendForgetPasswordMail=function(e,n){return a(this,void 0,void 0,(function*(){const o=(0,t.renderTemplate)("/src/templates/forgot-password-email.html",{url:`${d.default.BACKEND}/auth/reset?token=${n}`,name:e.username});return yield p(e.email,"Khôi phục mật khẩu trên "+d.default.APP_NAME,o)}))},t.startup=function(){return a(this,void 0,void 0,(function*(){return yield p("fakenoname02@gmail.com","Server started","Server started now")}))}},4747:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(5417),r=o(n(7469));class a{static validateUsername(e){if(!e||e.length<3||e.length>50)throw new i.InputError("Username có độ dài từ 3 đến 50 ký tự","username");return!0}static validateName(e){if(!e||e.length<3)throw new i.InputError("Invalid name","name")}static validatePassword(e){if(!e||e.length<8||e.length>50)throw new i.InputError("Mật khẩu có độ dài từ 8 đến 50 ký tự","password");return!0}static validateEmail(e){if(!e||!/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e))throw new i.InputError("Email không hợp lệ","email");return!0}static validateRePassword(e,t){if(t!=e)throw new i.InputError("Mật khẩu nhập lại cần giống mật khẩu","re_password")}validatePhone(e){if(!e||10!==e.length||!e.startsWith("0"))throw new i.InputError("Invalid phone number","phone");return!0}static validateLogin(e){a.validateUsername(e.username),a.validatePassword(e.password)}static validateRequestReset(e){e.username&&a.validateUsername(e.username)||e.uid&&r.default.validateUID(e.uid)||a.validateEmail(e.email)}static validateReset(e){a.validatePassword(e.password),a.validateRePassword(e.password,e.re_password)}static validateCreate(e){a.validateUsername(e.username),a.validateName(e.name)}}t.default=a},4216:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(2045),r=n(5417),a=o(n(7469));t.default=new class{validateRoomID(e){if(!e)throw new r.InputError("Must provide roomID","participants");return!0}validateCreateRoom(e){if(!e.participants)throw new r.InputError("Must provide participants","participants");if(!Array.isArray(e.participants))throw new r.InputError("Participants must be an array","participants");e.participants.map((e=>a.default.validateUID(e)))}validateDeleteRoom(e){this.validateRoomID(e.roomID)}validateGetRoom(e){this.validateRoomID(e.roomID)}validateUpdateRoom(e){this.validateRoomID(e.roomID)}validateCreateMessage(e){if(this.validateRoomID(e.roomID),!Object.values(i.MESSAGE_TYPES).includes(e.type))throw new Error("Invalid message type",{cause:"type"})}}},7469:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417);t.default=class{static validateUID(e){if(!e||24!==e.length)throw new o.InputError("UID không hợp lệ","uid");return!0}}},4539:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417);class i{static validateID(e){if(!e)throw new o.InputError("ID must be provided","id")}static validateImage(e){if(!e)throw new o.InputError("Image must be provided","image")}static validateRef(e){if(!e)throw new o.InputError("Ref must be provided","ref");if(24!=e.length)throw new o.InputError("Invalid ref","ref")}static validateType(e){if(!e)throw new o.InputError("Type must be provided","type");if(!["teacher","department","lab"].includes(e))throw new o.InputError("Invalid type","type")}static validateCreate(e){i.validateImage(e.image),i.validateRef(e.ref),i.validateType(e.type)}static validateDelete(e){i.validateID(e.id)}static validateUpdate(e){i.validateID(e.id),i.validateImage(e.image),i.validateRef(e.ref)}}t.default=i},8432:e=>{e.exports=require("bcryptjs")},9710:e=>{e.exports=require("cookie-parser")},3582:e=>{e.exports=require("cors")},5142:e=>{e.exports=require("dotenv")},6860:e=>{e.exports=require("express")},7520:e=>{e.exports=require("express-graphql")},7343:e=>{e.exports=require("graphql")},2097:e=>{e.exports=require("handlebars")},9344:e=>{e.exports=require("jsonwebtoken")},3464:e=>{e.exports=require("mongoosastic")},1185:e=>{e.exports=require("mongoose")},9470:e=>{e.exports=require("morgan")},5184:e=>{e.exports=require("nodemailer")},7773:e=>{e.exports=require("redis")},3952:e=>{e.exports=require("socket.io")},7147:e=>{e.exports=require("fs")},8849:e=>{e.exports=require("node:http")},1017:e=>{e.exports=require("path")}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={id:o,loaded:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}n.c=t,n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n(n.s=3607)})();